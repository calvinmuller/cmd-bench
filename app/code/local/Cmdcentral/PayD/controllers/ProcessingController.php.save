<?php
/* ----- Copyright (c) CMDcentral 2012 ----- */

class Creativo_MyGatePM_ProcessingController extends Mage_Core_Controller_Front_Action {

//  Define Variables
protected $_order = NULL;
protected $_paymentInst = NULL;

//  Action to be performed when the User Places an Order
public function redirectingAction() {
//  Get MyGatePM Functions, the Current Order and Order Placed Email Status
    $module = Mage::getModel('mygatepm/functions');
    $order = $module->getOrder();
    if ($module->getOrderPlacedEmail()) {$email = true;} else {$email = false;}
//  Set the Order Status and Comment
    $order->addStatusToHistory($module->getOrderStatus(),'The User was Redirected to MyGate for Payment',$email);
//  Notify User of Order via Email
    if ($email) {$order->sendNewOrderEmail();}
//  Save the Order
    $order->save();
//  Load Layout and add Processing Block for User Redirection
    $this->loadLayout();
//    $this->getLayout()->getBlock('root')->setTemplate('page/1column.phtml');
    $this->getLayout()->getBlock('content')->append($this->getLayout()->createBlock('mygatepm/processing'));
    $this->renderLayout();
}

//  Action to be performed when the Order is Successfully Paid

public function successfulAction() {
// Adding some security
    $post = $this->getRequest()->getPost();

//  Get MyGatePM Functions, the Current Order and Order Successful Email Status
    $module = Mage::getModel('mygatepm/functions');
    $order = $module->getOrder();
    if ($module->getOrderSuccessfulEmail()) {$email = true;} else {$email = false;}
//  Create the Invoice and Capture Payment
    $invoice = $order->prepareInvoice();
    $invoice->register()->capture();
    $order->addRelatedObject($invoice);
//  Set the Order Status and Comment
    $order->addStatusToHistory(Mage_Sales_Model_Order::STATE_COMPLETE,'The User Completed Payment with MyGate. Amount: '.$post['TXTPRICE'],$email);
//  Notify User of Invoice via Email
    if ($email) { $invoice->sendEmail(true);}
//  Save the Order
    $order->save();
//  Load Layout and add Successful Block

    $this->_redirect('checkout/onepage/success');
    return $this;

//    $this->loadLayout();
//    $this->getLayout()->getBlock('root')->setTemplate('page/1column.phtml');
//    $this->getLayout()->getBlock('content')->append($this->getLayout()->createBlock('mygatepm/successful'));
//    $this->renderLayout();
}

//  Action to be performed when the Order is Cancelled or Fails
public function failedAction() {
//  Get MyGatePM Functions, the Current Order and Order Failed Email Status
    $module = Mage::getModel('mygatepm/functions');
    $order = $module->getOrder();
    if ($module->getOrderFailedEmail()) {$email = true;} else {$email = false;}
//  Set the Order Status and Comment
    $order->addStatusToHistory(Mage_Sales_Model_Order::STATE_CANCELED,'The User Cancelled Payment or Failed to make a Successful Payment with MyGate',$email);
//  Notify User of Order via Email
    if ($email) {$order->sendNewOrderEmail();}
//  Save the Order
    $order->save();
//  Load Layout and add Successful Block
    $this->loadLayout();
    $this->getLayout()->getBlock('root')->setTemplate('page/1column.phtml');
    $this->getLayout()->getBlock('content')->append($this->getLayout()->createBlock('mygatepm/failed'));
    $this->renderLayout();
}

}
